# ============================================================================
# å·¥ä½œæµåç§°: C++ CI/CD Pipeline
# åŠŸèƒ½è¯´æ˜Ž: è¿™æ˜¯ä¸»è¦çš„CI/CDå·¥ä½œæµï¼Œè´Ÿè´£åœ¨å¤šä¸ªå¹³å°ä¸Šæž„å»ºã€æµ‹è¯•å’Œå‘å¸ƒC++é¡¹ç›®
# 
# ä¸»è¦ä»»åŠ¡:
#   1. build-and-test: åœ¨Ubuntu/macOS/Windowsä¸Šç¼–è¯‘å’Œæµ‹è¯•
#   2. code-quality: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆæ ¼å¼ã€è§„èŒƒç­‰ï¼‰
#   3. summary: ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
#   4. release: è‡ªåŠ¨åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶
#
# è§¦å‘æ–¹å¼:
#   - æŽ¨é€åˆ°main/masteråˆ†æ”¯
#   - åˆ›å»ºPull Requeståˆ°main/masteråˆ†æ”¯
#   - æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨Actionsé¡µé¢ç‚¹å‡»"Run workflow"ï¼‰
# ============================================================================

name: C++ CI/CD Pipeline

# ----------------------------------------------------------------------------
# è§¦å‘æ¡ä»¶é…ç½®
# ----------------------------------------------------------------------------
on:
  # å½“æŽ¨é€åˆ°mainæˆ–masteråˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  # ä¾‹å¦‚: git push origin main
  push:
    branches: [ main, master ]
  
  # å½“åˆ›å»ºé’ˆå¯¹main/masteråˆ†æ”¯çš„Pull Requestæ—¶è§¦å‘
  # ç”¨äºŽåœ¨åˆå¹¶å‰éªŒè¯ä»£ç è´¨é‡
  pull_request:
    branches: [ main, master ]
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  # åœ¨GitHubç½‘é¡µ Actions â†’ C++ CI/CD Pipeline â†’ Run workflow æŒ‰é’®
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡
jobs:
  # ========================================================================
  # ä»»åŠ¡1: æž„å»ºå’Œæµ‹è¯•
  # åŠŸèƒ½: åœ¨3ä¸ªä¸åŒæ“ä½œç³»ç»Ÿä¸Šç¼–è¯‘å’Œæµ‹è¯•C++ä»£ç 
  # å¹¶è¡Œæ‰§è¡Œ: 3ä¸ªå¹³å°åŒæ—¶è¿è¡Œï¼Œäº’ä¸å½±å“
  # ========================================================================
  build-and-test:
    name: Build and Test on ${{ matrix.os }}
    
    # çŸ©é˜µç­–ç•¥é…ç½®
    # è¯´æ˜Ž: matrixå…è®¸æˆ‘ä»¬ç”¨ç›¸åŒçš„æ­¥éª¤åœ¨ä¸åŒçŽ¯å¢ƒä¸‹å¹¶è¡Œè¿è¡Œ
    # è¿™é‡Œé…ç½®äº†3ä¸ªæ“ä½œç³»ç»Ÿ Ã— 1ä¸ªç¼–è¯‘ç±»åž‹ = 3ä¸ªå¹¶è¡Œä»»åŠ¡
    strategy:
      fail-fast: false  # é‡è¦: å³ä½¿ä¸€ä¸ªå¹³å°å¤±è´¥ï¼Œå…¶ä»–å¹³å°ç»§ç»­è¿è¡Œ
      matrix:
        # æ“ä½œç³»ç»Ÿåˆ—è¡¨ - GitHubæä¾›çš„é¢„é…ç½®è™šæ‹Ÿæœº
        os: [ubuntu-latest, macos-latest, windows-latest]
        
        # æž„å»ºç±»åž‹ - Releaseæ¨¡å¼ï¼ˆä¼˜åŒ–ç¼–è¯‘ï¼‰
        build_type: [Release]
        
        # ä¸ºæ¯ä¸ªæ“ä½œç³»ç»ŸæŒ‡å®šç¼–è¯‘å™¨
        include:
          - os: ubuntu-latest
            c_compiler: gcc          # Linuxä½¿ç”¨GCC
            cpp_compiler: g++
          - os: macos-latest
            c_compiler: clang        # macOSä½¿ç”¨Clang
            cpp_compiler: clang++
          - os: windows-latest
            c_compiler: cl           # Windowsä½¿ç”¨MSVC
            cpp_compiler: cl
    
    # æŒ‡å®šè¿è¡ŒçŽ¯å¢ƒ - ä»Žmatrixä¸­èŽ·å–æ“ä½œç³»ç»Ÿ
    runs-on: ${{ matrix.os }}
    
    # ä»»åŠ¡æ­¥éª¤
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # æ­¥éª¤2: è®¾ç½®CMake (è·¨å¹³å°)
      - name: ðŸ”§ Setup CMake
        uses: lukka/get-cmake@latest
      
      # æ­¥éª¤3: é…ç½®æž„å»ºçŽ¯å¢ƒ (Linux)
      - name: ðŸ§ Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      
      # æ­¥éª¤4: é…ç½®æž„å»ºçŽ¯å¢ƒ (macOS)
      - name: ðŸŽ Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake
      
      # æ­¥éª¤5: é…ç½®æž„å»ºçŽ¯å¢ƒ (Windows)
      - name: ðŸªŸ Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2
      
      # æ­¥éª¤6: åˆ›å»ºæž„å»ºç›®å½•
      - name: ðŸ“ Create Build Directory
        run: cmake -E make_directory ${{github.workspace}}/build
      
      # æ­¥éª¤7: é…ç½®CMake
      - name: âš™ï¸ Configure CMake
        working-directory: ${{github.workspace}}/build
        run: |
          cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
      
      # æ­¥éª¤8: ç¼–è¯‘é¡¹ç›®
      - name: ðŸ”¨ Build Project
        working-directory: ${{github.workspace}}/build
        run: cmake --build . --config ${{ matrix.build_type }}
      
      # æ­¥éª¤9: è¿è¡Œæµ‹è¯•
      - name: ðŸ§ª Run Tests
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{ matrix.build_type }} --output-on-failure
      
      # æ­¥éª¤10: è¿è¡Œä¸»ç¨‹åº (æ¼”ç¤º)
      - name: ðŸš€ Run Application
        working-directory: ${{github.workspace}}/build
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./${{ matrix.build_type }}/calculator_app.exe || ./calculator_app.exe
          else
            ./calculator_app
          fi
      
      # æ­¥éª¤11: ä¸Šä¼ æž„å»ºäº§ç‰©
      # è¯´æ˜Ž: å°†ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ä¿å­˜ä¸ºArtifactsï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨æˆ–ä¸‹è½½
      # retention-days: ä¿ç•™7å¤©åŽè‡ªåŠ¨åˆ é™¤ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
      - name: ðŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: calculator-${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            build/calculator_app*
            build/calculator_tests*
            build/${{ matrix.build_type }}/calculator_app*
            build/${{ matrix.build_type }}/calculator_tests*
          retention-days: 7

  # ========================================================================
  # ä»»åŠ¡2: ä»£ç è´¨é‡æ£€æŸ¥
  # åŠŸèƒ½: ä½¿ç”¨clang-formatæ£€æŸ¥ä»£ç æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒ
  # è¿è¡ŒçŽ¯å¢ƒ: ä»…åœ¨Ubuntuä¸Šè¿è¡Œï¼ˆèŠ‚çœèµ„æºï¼‰
  # ========================================================================
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Run clang-format check
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format
          echo "ä»£ç æ ¼å¼æ£€æŸ¥ (æ¼”ç¤º - å®žé™…é¡¹ç›®å¯ä»¥é…ç½®ä¸¥æ ¼æ£€æŸ¥)"
          find src tests -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror || true

  # ========================================================================
  # ä»»åŠ¡3: ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
  # åŠŸèƒ½: æ±‡æ€»æ‰€æœ‰ä»»åŠ¡çš„æ‰§è¡Œç»“æžœï¼Œç”Ÿæˆå¯è¯»æ€§å¼ºçš„æŠ¥å‘Š
  # ä¾èµ–: ç­‰å¾… build-and-test å’Œ code-quality å®ŒæˆåŽè¿è¡Œ
  # ç‰¹ç‚¹: æ— è®ºå‰é¢ä»»åŠ¡æˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šè¿è¡Œï¼ˆif: always()ï¼‰
  # ========================================================================
  summary:
    name: CI Summary
    needs: [build-and-test, code-quality]  # ä¾èµ–å‰ä¸¤ä¸ªä»»åŠ¡
    runs-on: ubuntu-latest
    if: always()  # å³ä½¿å‰é¢ä»»åŠ¡å¤±è´¥ä¹Ÿä¼šè¿è¡Œ
    
    steps:
      - name: ðŸ“Š Display Summary
        run: |
          echo "## CI/CD Pipeline æ‰§è¡Œå®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºå’Œæµ‹è¯•: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ„Ÿè°¢æ‚¨ä½¿ç”¨ GitHub Actions! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY

  # ========================================================================
  # ä»»åŠ¡4: åˆ›å»ºReleaseå¹¶ä¸Šä¼ æž„å»ºäº§ç‰©
  # åŠŸèƒ½: è‡ªåŠ¨æ‰“åŒ…å„å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶åˆ›å»ºGitHub Release
  # è§¦å‘æ¡ä»¶: 
  #   1. æŽ¨é€å¸¦æœ‰ v å¼€å¤´çš„ tag (å¦‚: git tag v1.0.0)
  #   2. æŽ¨é€åˆ° main åˆ†æ”¯ï¼ˆè‡ªåŠ¨åˆ›å»ºå¸¦æ—¥æœŸçš„ç‰ˆæœ¬ï¼‰
  # ä¾èµ–: ç­‰å¾… build-and-test å’Œ code-quality æˆåŠŸåŽè¿è¡Œ
  # ========================================================================
  release:
    name: Create Release
    needs: [build-and-test, code-quality]  # ä¾èµ–å‰ä¸¤ä¸ªä»»åŠ¡
    runs-on: ubuntu-latest
    # è§¦å‘æ¡ä»¶: tagä»¥vå¼€å¤´ æˆ– æŽ¨é€åˆ°mainåˆ†æ”¯
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºRelease
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´çš„GitåŽ†å²ï¼Œç”¨äºŽç”Ÿæˆå˜æ›´æ—¥å¿—
      
      # ä¸‹è½½æ‰€æœ‰å¹³å°çš„æž„å»ºäº§ç‰©
      # è¯´æ˜Ž: ä»Žå‰é¢çš„build-and-testä»»åŠ¡ä¸­ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
      - name: ðŸ“¦ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts  # ä¸‹è½½åˆ°artifactsç›®å½•
      
      # æ‰“åŒ…å„å¹³å°çš„æž„å»ºäº§ç‰©
      # è¯´æ˜Ž: å°†å„å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…æˆç”¨æˆ·å‹å¥½çš„åŽ‹ç¼©æ ¼å¼
      #       Linux/macOSä½¿ç”¨.tar.gzï¼ŒWindowsä½¿ç”¨.zip
      - name: ðŸ“¦ Package artifacts
        run: |
          cd artifacts
          
          # æ‰“åŒ…Linuxç‰ˆæœ¬ - ä½¿ç”¨tar.gzåŽ‹ç¼©
          if [ -d "calculator-ubuntu-latest-Release" ]; then
            cd calculator-ubuntu-latest-Release
            tar -czf ../calculator-linux-x64.tar.gz calculator_app calculator_tests
            cd ..
          fi
          
          # æ‰“åŒ…macOSç‰ˆæœ¬ - ä½¿ç”¨tar.gzåŽ‹ç¼©
          if [ -d "calculator-macos-latest-Release" ]; then
            cd calculator-macos-latest-Release
            tar -czf ../calculator-macos-x64.tar.gz calculator_app calculator_tests
            cd ..
          fi
          
          # æ‰“åŒ…Windowsç‰ˆæœ¬ - ä½¿ç”¨zipåŽ‹ç¼©
          if [ -d "calculator-windows-latest-Release" ]; then
            cd calculator-windows-latest-Release
            # å°è¯•ä¸¤ç§å¯èƒ½çš„è·¯å¾„ç»“æž„
            zip -r ../calculator-windows-x64.zip calculator_app.exe calculator_tests.exe 2>/dev/null || \
            zip -r ../calculator-windows-x64.zip Release/calculator_app.exe Release/calculator_tests.exe
            cd ..
          fi
          
          cd ..
          ls -lah artifacts/
      
      # ç”Ÿæˆç‰ˆæœ¬å·å’Œå‘å¸ƒè¯´æ˜Ž
      # è¯´æ˜Ž: æ ¹æ®è§¦å‘æ–¹å¼å†³å®šç‰ˆæœ¬å·æ ¼å¼
      #       tagè§¦å‘: ä½¿ç”¨tagåç§° (å¦‚ v1.0.0)
      #       pushè§¦å‘: ä½¿ç”¨æ—¥æœŸ+commit (å¦‚ v2025.01.28-abc1234)
      - name: ðŸ“ Generate version and release notes
        id: version
        run: |
          # å¦‚æžœæ˜¯tagè§¦å‘ï¼Œä½¿ç”¨tagåï¼›å¦åˆ™ä½¿ç”¨æ—¥æœŸ+commit hash
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž - åŒ…å«ä½¿ç”¨è¯´æ˜Žå’Œå˜æ›´è®°å½•
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ è‡ªåŠ¨æž„å»ºç‰ˆæœ¬
          
          æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒã€‚
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ï¼š
          
          - **ðŸ§ Linux**: `calculator-linux-x64.tar.gz`
            ```bash
            tar -xzf calculator-linux-x64.tar.gz
            ./calculator_app
            ```
          
          - **ðŸŽ macOS**: `calculator-macos-x64.tar.gz`
            ```bash
            tar -xzf calculator-macos-x64.tar.gz
            ./calculator_app
            ```
          
          - **ðŸªŸ Windows**: `calculator-windows-x64.zip`
            è§£åŽ‹åŽè¿è¡Œ `calculator_app.exe`
          
          ### âœ… æµ‹è¯•çŠ¶æ€
          
          æ‰€æœ‰å¹³å°çš„æž„å»ºå’Œæµ‹è¯•å‡å·²é€šè¿‡ï¼
          
          ### ðŸ“‹ å˜æ›´æ—¥å¿—
          
          EOF
          
          # æ·»åŠ æœ€è¿‘çš„æäº¤è®°å½• - æœ€è¿‘10æ¡
          echo "#### æœ€è¿‘æäº¤" >> release_notes.md
          git log --pretty=format:"- %s (%h)" -10 >> release_notes.md
          
          cat release_notes.md
      
      # åˆ›å»ºæˆ–æ›´æ–°Release
      # è¯´æ˜Ž: ä½¿ç”¨softprops/action-gh-releaseè‡ªåŠ¨åˆ›å»ºGitHub Release
      #       å¦‚æžœåŒåtagå·²å­˜åœ¨ï¼Œä¼šæ›´æ–°è¯¥Release
      - name: ðŸš€ Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false          # false=ç«‹å³å‘å¸ƒï¼Œtrue=ä¿å­˜ä¸ºè‰ç¨¿
          prerelease: false     # false=æ­£å¼ç‰ˆæœ¬ï¼Œtrue=é¢„å‘å¸ƒç‰ˆæœ¬
          files: |
            artifacts/calculator-linux-x64.tar.gz
            artifacts/calculator-macos-x64.tar.gz
            artifacts/calculator-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ç”ŸæˆReleaseæ‘˜è¦ - åœ¨GitHub Actionsçš„Summaryé¡µé¢æ˜¾ç¤º
      - name: ðŸ“¢ Release Summary
        run: |
          echo "## ðŸŽ‰ Release å·²åˆ›å»ºï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸‹è½½åœ°å€**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ åŒ…å«çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- calculator-linux-x64.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- calculator-macos-x64.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- calculator-windows-x64.zip" >> $GITHUB_STEP_SUMMARY
