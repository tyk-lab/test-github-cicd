name: C++ CI/CD Pipeline

# è§¦å‘æ¡ä»¶
on:
  # å½“æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]
  
  # å½“åˆ›å»ºé’ˆå¯¹mainåˆ†æ”¯çš„Pull Requestæ—¶è§¦å‘
  pull_request:
    branches: [ main, master ]
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡
jobs:
  # æž„å»ºå’Œæµ‹è¯•ä»»åŠ¡
  build-and-test:
    # ä»»åŠ¡åç§°
    name: Build and Test on ${{ matrix.os }}
    
    # ä½¿ç”¨çŸ©é˜µç­–ç•¥åœ¨å¤šä¸ªå¹³å°ä¸Šè¿è¡Œ
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°ç»§ç»­è¿è¡Œ
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build_type: [Release]
        include:
          - os: ubuntu-latest
            c_compiler: gcc
            cpp_compiler: g++
          - os: macos-latest
            c_compiler: clang
            cpp_compiler: clang++
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
    
    # è¿è¡ŒçŽ¯å¢ƒ
    runs-on: ${{ matrix.os }}
    
    # ä»»åŠ¡æ­¥éª¤
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # æ­¥éª¤2: è®¾ç½®CMake (è·¨å¹³å°)
      - name: ðŸ”§ Setup CMake
        uses: lukka/get-cmake@latest
      
      # æ­¥éª¤3: é…ç½®æž„å»ºçŽ¯å¢ƒ (Linux)
      - name: ðŸ§ Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      
      # æ­¥éª¤4: é…ç½®æž„å»ºçŽ¯å¢ƒ (macOS)
      - name: ðŸŽ Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake
      
      # æ­¥éª¤5: é…ç½®æž„å»ºçŽ¯å¢ƒ (Windows)
      - name: ðŸªŸ Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2
      
      # æ­¥éª¤6: åˆ›å»ºæž„å»ºç›®å½•
      - name: ðŸ“ Create Build Directory
        run: cmake -E make_directory ${{github.workspace}}/build
      
      # æ­¥éª¤7: é…ç½®CMake
      - name: âš™ï¸ Configure CMake
        working-directory: ${{github.workspace}}/build
        run: |
          cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
      
      # æ­¥éª¤8: ç¼–è¯‘é¡¹ç›®
      - name: ðŸ”¨ Build Project
        working-directory: ${{github.workspace}}/build
        run: cmake --build . --config ${{ matrix.build_type }}
      
      # æ­¥éª¤9: è¿è¡Œæµ‹è¯•
      - name: ðŸ§ª Run Tests
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{ matrix.build_type }} --output-on-failure
      
      # æ­¥éª¤10: è¿è¡Œä¸»ç¨‹åº (æ¼”ç¤º)
      - name: ðŸš€ Run Application
        working-directory: ${{github.workspace}}/build
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./${{ matrix.build_type }}/calculator_app.exe || ./calculator_app.exe
          else
            ./calculator_app
          fi
      
      # æ­¥éª¤11: ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: ðŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: calculator-${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            build/calculator_app*
            build/calculator_tests*
            build/${{ matrix.build_type }}/calculator_app*
            build/${{ matrix.build_type }}/calculator_tests*
          retention-days: 7

  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡ (å¯é€‰)
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Run clang-format check
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format
          echo "ä»£ç æ ¼å¼æ£€æŸ¥ (æ¼”ç¤º - å®žé™…é¡¹ç›®å¯ä»¥é…ç½®ä¸¥æ ¼æ£€æŸ¥)"
          find src tests -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror || true

  # æ€»ç»“ä»»åŠ¡
  summary:
    name: CI Summary
    needs: [build-and-test, code-quality]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Display Summary
        run: |
          echo "## CI/CD Pipeline æ‰§è¡Œå®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºå’Œæµ‹è¯•: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ„Ÿè°¢æ‚¨ä½¿ç”¨ GitHub Actions! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
