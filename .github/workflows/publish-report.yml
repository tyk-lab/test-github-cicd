# ============================================================================
# å·¥ä½œæµåç§°: Publish Test Report
# åŠŸèƒ½è¯´æ˜: åœ¨CI/CD Pipelineå®Œæˆåï¼Œè‡ªåŠ¨ç”Ÿæˆç²¾ç¾çš„HTMLæµ‹è¯•æŠ¥å‘Šå¹¶å‘å¸ƒåˆ°GitHub Pages
# 
# è§¦å‘æ–¹å¼:
#   - å½“ "C++ CI/CD Pipeline" å·¥ä½œæµå®Œæˆæ—¶è‡ªåŠ¨è§¦å‘
#   - æ— è®ºCI/CDæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šç”ŸæˆæŠ¥å‘Š
#
# è¾“å‡º:
#   - GitHub Pagesç½‘ç«™: https://tyk-lab.github.io/test-github-cicd/
#   - åŒ…å«æ„å»ºçŠ¶æ€ã€æµ‹è¯•ç»“æœã€å¹³å°ä¿¡æ¯ç­‰
#
# æ³¨æ„äº‹é¡¹:
#   - éœ€è¦åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨GitHub Pages (Settings â†’ Pages)
#   - é€‰æ‹© "gh-pages" åˆ†æ”¯ä½œä¸ºæº
# ============================================================================

name: Publish Test Report

# ----------------------------------------------------------------------------
# è§¦å‘æ¡ä»¶é…ç½®
# ----------------------------------------------------------------------------
on:
  # ç›‘å¬æŒ‡å®šå·¥ä½œæµçš„å®Œæˆäº‹ä»¶
  # è¯´æ˜: å½“"C++ CI/CD Pipeline"è¿è¡Œå®Œæˆåï¼Œè‡ªåŠ¨è§¦å‘æœ¬å·¥ä½œæµ
  workflow_run:
    workflows: ["C++ CI/CD Pipeline"]  # è¦ç›‘å¬çš„å·¥ä½œæµåç§°
    types:
      - completed  # å®Œæˆæ—¶è§¦å‘ï¼ˆåŒ…æ‹¬æˆåŠŸã€å¤±è´¥ã€å–æ¶ˆï¼‰

# ----------------------------------------------------------------------------
# æƒé™é…ç½®
# è¯´æ˜: éœ€è¦å†™æƒé™æ¥æ¨é€åˆ°gh-pagesåˆ†æ”¯å’Œéƒ¨ç½²Pages
# ----------------------------------------------------------------------------
permissions:
  contents: write      # å†™å…¥ä»“åº“å†…å®¹ï¼ˆæ¨é€åˆ°gh-pagesåˆ†æ”¯ï¼‰
  pages: write         # éƒ¨ç½²GitHub Pages
  id-token: write      # ç”¨äºPageséƒ¨ç½²è®¤è¯

jobs:
  # ========================================================================
  # ä»»åŠ¡: å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
  # åŠŸèƒ½: 
  #   1. ä¸‹è½½CI/CDçš„æ„å»ºäº§ç‰©
  #   2. ç”Ÿæˆç²¾ç¾çš„HTMLæµ‹è¯•æŠ¥å‘Š
  #   3. å‘å¸ƒåˆ°GitHub Pagesä¾›åœ¨çº¿æŸ¥çœ‹
  # ========================================================================
  publish-report:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # æ­¥éª¤2: ä¸‹è½½CI/CDäº§ç‰©
      # è¯´æ˜: ä»è§¦å‘æ­¤å·¥ä½œæµçš„CI/CDè¿è¡Œä¸­ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      # continue-on-error: å³ä½¿ä¸‹è½½å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œç¡®ä¿æŠ¥å‘Šèƒ½ç”Ÿæˆ
      - name: ğŸ“¦ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          run-id: ${{ github.event.workflow_run.id }}  # ä½¿ç”¨è§¦å‘å·¥ä½œæµçš„è¿è¡ŒID
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # å…è®¸å¤±è´¥ï¼ŒæŠ¥å‘Šä»ä¼šç”Ÿæˆ
      
      # æ­¥éª¤3: ç”ŸæˆHTMLæŠ¥å‘Š
      # è¯´æ˜: åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æµ‹è¯•ä¿¡æ¯çš„ç²¾ç¾ç½‘é¡µ
      - name: ğŸ“„ Generate HTML Report
        run: |
          mkdir -p public
          
          # è·å–å·¥ä½œæµçŠ¶æ€
          # æ ¹æ®CI/CDçš„æˆåŠŸ/å¤±è´¥çŠ¶æ€è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºå›¾æ ‡å’Œé¢œè‰²
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="æˆåŠŸ"
            STATUS_COLOR="green"
          else
            STATUS_ICON="âŒ"
            STATUS_TEXT="å¤±è´¥"
            STATUS_COLOR="red"
          fi
          
          # ç”ŸæˆHTMLæŠ¥å‘Š
          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CI/CD æµ‹è¯•æŠ¥å‘Š - test-github-cicd</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 12px;
                      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
                      overflow: hidden;
                  }
                  
                  .header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 40px;
                      text-align: center;
                  }
                  
                  .header h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  
                  .header p {
                      font-size: 1.1em;
                      opacity: 0.9;
                  }
                  
                  .content {
                      padding: 40px;
                  }
                  
                  .status-card {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 30px;
                      margin-bottom: 30px;
                      text-align: center;
                  }
                  
                  .status-icon {
                      font-size: 4em;
                      margin-bottom: 15px;
                  }
                  
                  .status-text {
                      font-size: 1.5em;
                      font-weight: bold;
                      color: STATUS_COLOR_PLACEHOLDER;
                  }
                  
                  .info-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin-bottom: 30px;
                  }
                  
                  .info-card {
                      background: #f8f9fa;
                      border-left: 4px solid #667eea;
                      padding: 20px;
                      border-radius: 4px;
                  }
                  
                  .info-card h3 {
                      color: #667eea;
                      margin-bottom: 10px;
                      font-size: 0.9em;
                      text-transform: uppercase;
                  }
                  
                  .info-card p {
                      color: #333;
                      font-size: 1.1em;
                      font-weight: 500;
                  }
                  
                  .platforms {
                      margin-bottom: 30px;
                  }
                  
                  .platforms h2 {
                      margin-bottom: 20px;
                      color: #333;
                  }
                  
                  .platform-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                  }
                  
                  .platform-card {
                      background: white;
                      border: 2px solid #e9ecef;
                      border-radius: 8px;
                      padding: 20px;
                      transition: transform 0.2s, box-shadow 0.2s;
                  }
                  
                  .platform-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
                  }
                  
                  .platform-card h3 {
                      color: #667eea;
                      margin-bottom: 15px;
                      display: flex;
                      align-items: center;
                      gap: 10px;
                  }
                  
                  .platform-card .icon {
                      font-size: 1.5em;
                  }
                  
                  .test-results {
                      background: #f8f9fa;
                      padding: 15px;
                      border-radius: 4px;
                      margin-top: 10px;
                      font-family: 'Courier New', monospace;
                      font-size: 0.9em;
                      white-space: pre-wrap;
                      max-height: 200px;
                      overflow-y: auto;
                  }
                  
                  .links {
                      display: flex;
                      gap: 15px;
                      justify-content: center;
                      flex-wrap: wrap;
                  }
                  
                  .btn {
                      display: inline-block;
                      padding: 12px 24px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      text-decoration: none;
                      border-radius: 6px;
                      font-weight: 500;
                      transition: transform 0.2s;
                  }
                  
                  .btn:hover {
                      transform: translateY(-2px);
                  }
                  
                  .footer {
                      text-align: center;
                      padding: 20px;
                      color: #666;
                      border-top: 1px solid #e9ecef;
                  }
                  
                  .success { color: #28a745; }
                  .failed { color: #dc3545; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ§ª CI/CD æµ‹è¯•æŠ¥å‘Š</h1>
                      <p>C++ Calculator Project - æŒç»­é›†æˆå’Œéƒ¨ç½²</p>
                  </div>
                  
                  <div class="content">
                      <div class="status-card">
                          <div class="status-icon">STATUS_ICON_PLACEHOLDER</div>
                          <div class="status-text">æ„å»ºçŠ¶æ€: STATUS_TEXT_PLACEHOLDER</div>
                      </div>
                      
                      <div class="info-grid">
                          <div class="info-card">
                              <h3>ğŸ“… æ„å»ºæ—¶é—´</h3>
                              <p>BUILD_TIME_PLACEHOLDER</p>
                          </div>
                          <div class="info-card">
                              <h3>ğŸ”„ å·¥ä½œæµ</h3>
                              <p>C++ CI/CD Pipeline</p>
                          </div>
                          <div class="info-card">
                              <h3>ğŸŒ¿ åˆ†æ”¯</h3>
                              <p>BRANCH_PLACEHOLDER</p>
                          </div>
                          <div class="info-card">
                              <h3>ğŸ“ æäº¤</h3>
                              <p>COMMIT_PLACEHOLDER</p>
                          </div>
                      </div>
                      
                      <div class="platforms">
                          <h2>ğŸ–¥ï¸ å¹³å°æµ‹è¯•ç»“æœ</h2>
                          <div class="platform-grid">
                              <div class="platform-card">
                                  <h3><span class="icon">ğŸ§</span> Ubuntu Linux</h3>
                                  <p>âœ… ç¼–è¯‘æˆåŠŸ</p>
                                  <p>âœ… æµ‹è¯•é€šè¿‡</p>
                                  <div class="test-results">UBUNTU_RESULTS_PLACEHOLDER</div>
                              </div>
                              
                              <div class="platform-card">
                                  <h3><span class="icon">ğŸ</span> macOS</h3>
                                  <p>âœ… ç¼–è¯‘æˆåŠŸ</p>
                                  <p>âœ… æµ‹è¯•é€šè¿‡</p>
                                  <div class="test-results">MACOS_RESULTS_PLACEHOLDER</div>
                              </div>
                              
                              <div class="platform-card">
                                  <h3><span class="icon">ğŸªŸ</span> Windows</h3>
                                  <p>âœ… ç¼–è¯‘æˆåŠŸ</p>
                                  <p>âœ… æµ‹è¯•é€šè¿‡</p>
                                  <div class="test-results">WINDOWS_RESULTS_PLACEHOLDER</div>
                              </div>
                          </div>
                      </div>
                      
                      <div class="links">
                          <a href="https://github.com/tyk-lab/test-github-cicd" class="btn">ğŸ“‚ æŸ¥çœ‹æºç </a>
                          <a href="https://github.com/tyk-lab/test-github-cicd/actions" class="btn">ğŸ“Š CI/CD å†å²</a>
                          <a href="WORKFLOW_URL_PLACEHOLDER" class="btn">ğŸ”— æœ¬æ¬¡æ„å»ºè¯¦æƒ…</a>
                      </div>
                  </div>
                  
                  <div class="footer">
                      <p>ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | æœ€åæ›´æ–°: UPDATE_TIME_PLACEHOLDER</p>
                  </div>
              </div>
          </body>
          </html>
          HTMLEOF
          
          # æ›¿æ¢å ä½ç¬¦
          sed -i "s/STATUS_ICON_PLACEHOLDER/${STATUS_ICON}/g" public/index.html
          sed -i "s/STATUS_TEXT_PLACEHOLDER/${STATUS_TEXT}/g" public/index.html
          sed -i "s/STATUS_COLOR_PLACEHOLDER/${STATUS_COLOR}/g" public/index.html
          sed -i "s|BUILD_TIME_PLACEHOLDER|$(date '+%Y-%m-%d %H:%M:%S UTC')|g" public/index.html
          sed -i "s/BRANCH_PLACEHOLDER/${{ github.event.workflow_run.head_branch }}/g" public/index.html
          sed -i "s/COMMIT_PLACEHOLDER/${{ github.event.workflow_run.head_sha }}/g" public/index.html | cut -c1-7
          sed -i "s|WORKFLOW_URL_PLACEHOLDER|https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}|g" public/index.html
          sed -i "s|UPDATE_TIME_PLACEHOLDER|$(date '+%Y-%m-%d %H:%M:%S UTC')|g" public/index.html
          
          # æå–æµ‹è¯•ç»“æœ
          if [ -d "artifacts" ]; then
            for platform in ubuntu-latest macos-latest windows-latest; do
              PLATFORM_UPPER=$(echo $platform | tr '[:lower:]' '[:upper:]' | tr '-' '_')
              
              if [ -f "artifacts/calculator-${platform}-Release/test_results_${platform}.txt" ]; then
                RESULT=$(cat "artifacts/calculator-${platform}-Release/test_results_${platform}.txt" | head -20)
              else
                RESULT="æµ‹è¯•ç»“æœæ–‡ä»¶æœªæ‰¾åˆ°"
              fi
              
              # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦å¹¶æ›¿æ¢
              RESULT_ESCAPED=$(echo "$RESULT" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              sed -i "s|${PLATFORM_UPPER}_RESULTS_PLACEHOLDER|${RESULT_ESCAPED}|g" public/index.html
            done
          else
            sed -i "s|UBUNTU_RESULTS_PLACEHOLDER|æ„å»ºäº§ç‰©ä¸‹è½½ä¸­...|g" public/index.html
            sed -i "s|MACOS_RESULTS_PLACEHOLDER|æ„å»ºäº§ç‰©ä¸‹è½½ä¸­...|g" public/index.html
            sed -i "s|WINDOWS_RESULTS_PLACEHOLDER|æ„å»ºäº§ç‰©ä¸‹è½½ä¸­...|g" public/index.html
          fi
          
          echo "HTMLæŠ¥å‘Šå·²ç”Ÿæˆ"
          ls -la public/
      
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
