# ============================================================================
# Â∑•‰ΩúÊµÅÂêçÁß∞: Publish Test Report
# ÂäüËÉΩËØ¥Êòé: Âú®CI/CD PipelineÂÆåÊàêÂêéÔºåËá™Âä®ÁîüÊàêÁ≤æÁæéÁöÑHTMLÊµãËØïÊä•ÂëäÂπ∂ÂèëÂ∏ÉÂà∞GitHub Pages
# 
# Ëß¶ÂèëÊñπÂºè:
#   - ÂΩì "C++ CI/CD Pipeline" Â∑•‰ΩúÊµÅÂÆåÊàêÊó∂Ëá™Âä®Ëß¶Âèë
#   - Êó†ËÆ∫CI/CDÊàêÂäüÊàñÂ§±Ë¥•ÈÉΩ‰ºöÁîüÊàêÊä•Âëä
#
# ËæìÂá∫:
#   - GitHub PagesÁΩëÁ´ô: https://tyk-lab.github.io/test-github-cicd/
#   - ÂåÖÂê´ÊûÑÂª∫Áä∂ÊÄÅ„ÄÅÊµãËØïÁªìÊûú„ÄÅÂπ≥Âè∞‰ø°ÊÅØÁ≠â
#
# Ê≥®ÊÑè‰∫ãÈ°π:
#   - ÈúÄË¶ÅÂú®‰ªìÂ∫ìËÆæÁΩÆ‰∏≠ÂêØÁî®GitHub Pages (Settings ‚Üí Pages)
#   - ÈÄâÊã© "gh-pages" ÂàÜÊîØ‰Ωú‰∏∫Ê∫ê
# ============================================================================

name: Publish Test Report

# ----------------------------------------------------------------------------
# Ëß¶ÂèëÊù°‰ª∂ÈÖçÁΩÆ
# ----------------------------------------------------------------------------
on:
  # ÁõëÂê¨ÊåáÂÆöÂ∑•‰ΩúÊµÅÁöÑÂÆåÊàê‰∫ã‰ª∂
  # ËØ¥Êòé: ÂΩì"C++ CI/CD Pipeline"ËøêË°åÂÆåÊàêÂêéÔºåËá™Âä®Ëß¶ÂèëÊú¨Â∑•‰ΩúÊµÅ
  workflow_run:
    workflows: ["C++ CI/CD Pipeline"]  # Ë¶ÅÁõëÂê¨ÁöÑÂ∑•‰ΩúÊµÅÂêçÁß∞
    types:
      - completed  # ÂÆåÊàêÊó∂Ëß¶ÂèëÔºàÂåÖÊã¨ÊàêÂäü„ÄÅÂ§±Ë¥•„ÄÅÂèñÊ∂àÔºâ

# ----------------------------------------------------------------------------
# ÊùÉÈôêÈÖçÁΩÆ
# ËØ¥Êòé: ÈúÄË¶ÅÂÜôÊùÉÈôêÊù•Êé®ÈÄÅÂà∞gh-pagesÂàÜÊîØÂíåÈÉ®ÁΩ≤Pages
# ----------------------------------------------------------------------------
permissions:
  contents: write      # ÂÜôÂÖ•‰ªìÂ∫ìÂÜÖÂÆπÔºàÊé®ÈÄÅÂà∞gh-pagesÂàÜÊîØÔºâ
  pages: write         # ÈÉ®ÁΩ≤GitHub Pages
  id-token: write      # Áî®‰∫éPagesÈÉ®ÁΩ≤ËÆ§ËØÅ

jobs:
  # ========================================================================
  # ‰ªªÂä°: ÂèëÂ∏ÉÊµãËØïÊä•Âëä
  # ÂäüËÉΩ: 
  #   1. ‰∏ãËΩΩCI/CDÁöÑÊûÑÂª∫‰∫ßÁâ©
  #   2. ÁîüÊàêÁ≤æÁæéÁöÑHTMLÊµãËØïÊä•Âëä
  #   3. ÂèëÂ∏ÉÂà∞GitHub Pages‰æõÂú®Á∫øÊü•Áúã
  # ========================================================================
  publish-report:
    runs-on: ubuntu-latest
    
    steps:
      # Ê≠•È™§1: Ê£ÄÂá∫‰ª£Á†Å
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      # Ê≠•È™§2: ‰∏ãËΩΩCI/CD‰∫ßÁâ©
      # ËØ¥Êòé: ‰ªéËß¶ÂèëÊ≠§Â∑•‰ΩúÊµÅÁöÑCI/CDËøêË°å‰∏≠‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
      # continue-on-error: Âç≥‰Ωø‰∏ãËΩΩÂ§±Ë¥•‰πüÁªßÁª≠ÊâßË°åÔºåÁ°Æ‰øùÊä•ÂëäËÉΩÁîüÊàê
      - name: üì¶ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          run-id: ${{ github.event.workflow_run.id }}  # ‰ΩøÁî®Ëß¶ÂèëÂ∑•‰ΩúÊµÅÁöÑËøêË°åID
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # ÂÖÅËÆ∏Â§±Ë¥•ÔºåÊä•Âëä‰ªç‰ºöÁîüÊàê
      
      # Ê≠•È™§3: ÁîüÊàêHTMLÊä•Âëä
      # ËØ¥Êòé: ÂàõÂª∫‰∏Ä‰∏™ÂåÖÂê´ÊâÄÊúâÊµãËØï‰ø°ÊÅØÁöÑÁ≤æÁæéÁΩëÈ°µ
      - name: üìÑ Generate HTML Report
        run: |
          mkdir -p public
          
          # Ëé∑ÂèñÂ∑•‰ΩúÊµÅÁä∂ÊÄÅ
          # Ê†πÊçÆCI/CDÁöÑÊàêÂäü/Â§±Ë¥•Áä∂ÊÄÅËÆæÁΩÆ‰∏çÂêåÁöÑÊòæÁ§∫ÂõæÊ†áÂíåÈ¢úËâ≤
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            STATUS_ICON="‚úÖ"
            STATUS_TEXT="ÊàêÂäü"
            STATUS_COLOR="green"
          else
            STATUS_ICON="‚ùå"
            STATUS_TEXT="Â§±Ë¥•"
            STATUS_COLOR="red"
          fi
          
          # ÁîüÊàêHTMLÊä•Âëä
          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CI/CD ÊµãËØïÊä•Âëä - test-github-cicd</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 12px;
                      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
                      overflow: hidden;
                  }
                  
                  .header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 40px;
                      text-align: center;
                  }
                  
                  .header h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  
                  .header p {
                      font-size: 1.1em;
                      opacity: 0.9;
                  }
                  
                  .content {
                      padding: 40px;
                  }
                  
                  .status-card {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 30px;
                      margin-bottom: 30px;
                      text-align: center;
                  }
                  
                  .status-icon {
                      font-size: 4em;
                      margin-bottom: 15px;
                  }
                  
                  .status-text {
                      font-size: 1.5em;
                      font-weight: bold;
                      color: STATUS_COLOR_PLACEHOLDER;
                  }
                  
                  .info-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin-bottom: 30px;
                  }
                  
                  .info-card {
                      background: #f8f9fa;
                      border-left: 4px solid #667eea;
                      padding: 20px;
                      border-radius: 4px;
                  }
                  
                  .info-card h3 {
                      color: #667eea;
                      margin-bottom: 10px;
                      font-size: 0.9em;
                      text-transform: uppercase;
                  }
                  
                  .info-card p {
                      color: #333;
                      font-size: 1.1em;
                      font-weight: 500;
                  }
                  
                  .platforms {
                      margin-bottom: 30px;
                  }
                  
                  .platforms h2 {
                      margin-bottom: 20px;
                      color: #333;
                  }
                  
                  .platform-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                  }
                  
                  .platform-card {
                      background: white;
                      border: 2px solid #e9ecef;
                      border-radius: 8px;
                      padding: 20px;
                      transition: transform 0.2s, box-shadow 0.2s;
                  }
                  
                  .platform-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
                  }
                  
                  .platform-card h3 {
                      color: #667eea;
                      margin-bottom: 15px;
                      display: flex;
                      align-items: center;
                      gap: 10px;
                  }
                  
                  .platform-card .icon {
                      font-size: 1.5em;
                  }
                  
                  .test-results {
                      background: #f8f9fa;
                      padding: 15px;
                      border-radius: 4px;
                      margin-top: 10px;
                      font-family: 'Courier New', monospace;
                      font-size: 0.9em;
                      white-space: pre-wrap;
                      max-height: 200px;
                      overflow-y: auto;
                  }
                  
                  .links {
                      display: flex;
                      gap: 15px;
                      justify-content: center;
                      flex-wrap: wrap;
                  }
                  
                  .btn {
                      display: inline-block;
                      padding: 12px 24px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      text-decoration: none;
                      border-radius: 6px;
                      font-weight: 500;
                      transition: transform 0.2s;
                  }
                  
                  .btn:hover {
                      transform: translateY(-2px);
                  }
                  
                  .footer {
                      text-align: center;
                      padding: 20px;
                      color: #666;
                      border-top: 1px solid #e9ecef;
                  }
                  
                  .success { color: #28a745; }
                  .failed { color: #dc3545; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üß™ CI/CD ÊµãËØïÊä•Âëä</h1>
                      <p>C++ Calculator Project - ÊåÅÁª≠ÈõÜÊàêÂíåÈÉ®ÁΩ≤</p>
                  </div>
                  
                  <div class="content">
                      <div class="status-card">
                          <div class="status-icon">STATUS_ICON_PLACEHOLDER</div>
                          <div class="status-text">ÊûÑÂª∫Áä∂ÊÄÅ: STATUS_TEXT_PLACEHOLDER</div>
                      </div>
                      
                      <div class="info-grid">
                          <div class="info-card">
                              <h3>üìÖ ÊûÑÂª∫Êó∂Èó¥</h3>
                              <p>BUILD_TIME_PLACEHOLDER</p>
                          </div>
                          <div class="info-card">
                              <h3>üîÑ Â∑•‰ΩúÊµÅ</h3>
                              <p>C++ CI/CD Pipeline</p>
                          </div>
                          <div class="info-card">
                              <h3>üåø ÂàÜÊîØ</h3>
                              <p>BRANCH_PLACEHOLDER</p>
                          </div>
                          <div class="info-card">
                              <h3>üìù Êèê‰∫§</h3>
                              <p>COMMIT_PLACEHOLDER</p>
                          </div>
                      </div>
                      
                      <div class="platforms">
                          <h2>üñ•Ô∏è Âπ≥Âè∞ÊµãËØïÁªìÊûú</h2>
                          <div class="platform-grid">
                              <div class="platform-card">
                                  <h3><span class="icon">üêß</span> Ubuntu Linux</h3>
                                  <p>‚úÖ ÁºñËØëÊàêÂäü</p>
                                  <p>‚úÖ ÊµãËØïÈÄöËøá</p>
                                  <div class="test-results">UBUNTU_RESULTS_PLACEHOLDER</div>
                              </div>
                              
                              <div class="platform-card">
                                  <h3><span class="icon">üçé</span> macOS</h3>
                                  <p>‚úÖ ÁºñËØëÊàêÂäü</p>
                                  <p>‚úÖ ÊµãËØïÈÄöËøá</p>
                                  <div class="test-results">MACOS_RESULTS_PLACEHOLDER</div>
                              </div>
                              
                              <div class="platform-card">
                                  <h3><span class="icon">ü™ü</span> Windows</h3>
                                  <p>‚úÖ ÁºñËØëÊàêÂäü</p>
                                  <p>‚úÖ ÊµãËØïÈÄöËøá</p>
                                  <div class="test-results">WINDOWS_RESULTS_PLACEHOLDER</div>
                              </div>
                          </div>
                      </div>
                      
                      <div class="links">
                          <a href="https://github.com/tyk-lab/test-github-cicd" class="btn">üìÇ Êü•ÁúãÊ∫êÁ†Å</a>
                          <a href="https://github.com/tyk-lab/test-github-cicd/actions" class="btn">üìä CI/CD ÂéÜÂè≤</a>
                          <a href="WORKFLOW_URL_PLACEHOLDER" class="btn">üîó Êú¨Ê¨°ÊûÑÂª∫ËØ¶ÊÉÖ</a>
                      </div>
                  </div>
                  
                  <div class="footer">
                      <p>Áî± GitHub Actions Ëá™Âä®ÁîüÊàê | ÊúÄÂêéÊõ¥Êñ∞: UPDATE_TIME_PLACEHOLDER</p>
                  </div>
              </div>
          </body>
          </html>
          HTMLEOF
          
          # ÊõøÊç¢Âç†‰ΩçÁ¨¶
          sed -i "s/STATUS_ICON_PLACEHOLDER/${STATUS_ICON}/g" public/index.html
          sed -i "s/STATUS_TEXT_PLACEHOLDER/${STATUS_TEXT}/g" public/index.html
          sed -i "s/STATUS_COLOR_PLACEHOLDER/${STATUS_COLOR}/g" public/index.html
          sed -i "s|BUILD_TIME_PLACEHOLDER|$(date '+%Y-%m-%d %H:%M:%S UTC')|g" public/index.html
          sed -i "s/BRANCH_PLACEHOLDER/${{ github.event.workflow_run.head_branch }}/g" public/index.html
          sed -i "s/COMMIT_PLACEHOLDER/${{ github.event.workflow_run.head_sha }}/g" public/index.html | cut -c1-7
          sed -i "s|WORKFLOW_URL_PLACEHOLDER|https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}|g" public/index.html
          sed -i "s|UPDATE_TIME_PLACEHOLDER|$(date '+%Y-%m-%d %H:%M:%S UTC')|g" public/index.html
          
          # ÊèêÂèñÊµãËØïÁªìÊûú
          if [ -d "artifacts" ]; then
            for platform in ubuntu-latest macos-latest windows-latest; do
              PLATFORM_UPPER=$(echo $platform | tr '[:lower:]' '[:upper:]' | tr '-' '_')
              
              if [ -f "artifacts/calculator-${platform}-Release/test_results_${platform}.txt" ]; then
                RESULT=$(cat "artifacts/calculator-${platform}-Release/test_results_${platform}.txt" | head -20)
              else
                RESULT="ÊµãËØïÁªìÊûúÊñá‰ª∂Êú™ÊâæÂà∞"
              fi
              
              # ËΩ¨‰πâÁâπÊÆäÂ≠óÁ¨¶Âπ∂ÊõøÊç¢
              RESULT_ESCAPED=$(echo "$RESULT" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              sed -i "s|${PLATFORM_UPPER}_RESULTS_PLACEHOLDER|${RESULT_ESCAPED}|g" public/index.html
            done
          else
            sed -i "s|UBUNTU_RESULTS_PLACEHOLDER|ÊûÑÂª∫‰∫ßÁâ©‰∏ãËΩΩ‰∏≠...|g" public/index.html
            sed -i "s|MACOS_RESULTS_PLACEHOLDER|ÊûÑÂª∫‰∫ßÁâ©‰∏ãËΩΩ‰∏≠...|g" public/index.html
            sed -i "s|WINDOWS_RESULTS_PLACEHOLDER|ÊûÑÂª∫‰∫ßÁâ©‰∏ãËΩΩ‰∏≠...|g" public/index.html
          fi
          
          echo "HTMLÊä•ÂëäÂ∑≤ÁîüÊàê"
          ls -la public/
      
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
